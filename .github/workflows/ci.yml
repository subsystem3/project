name: CI

on:
  push:
    paths:
      - 'Dockerfile'
    branches: [dev, main]
  pull_request:
    paths:
      - 'Dockerfile'
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: read

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      modified: ${{ steps.check.outputs.modified }}
    steps:
    - name: Check out main branch
      uses: actions/checkout@v3.5.3
      with:
        ref: main
        fetch-depth: '0'

    - name: Check if Dockerfile was modified
      id: check
      run: |
        git fetch origin ${{ github.base_ref }}
        DIFF=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.ref }} -- Dockerfile)
        if [[ -n "$DIFF" ]]; then
          echo "::set-output name=modified::true"
        else
          echo "::set-output name=modified::false"
        fi

  docker:
    needs: check
    if: needs.check.outputs.modified == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Check out main branch
      uses: actions/checkout@v3.5.3
      with:
        ref: main
        fetch-depth: '0'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Log in to GitHub Packages
      uses: docker/login-action@v2.2.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push Docker Build Image
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}/build:${{ github.ref }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache

  build:
    needs: docker
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}/build:${{ github.ref }}
    steps:
      - name: Check out dev branch
        uses: actions/checkout@v3.5.3
        with:
          ref: dev

      - name: Set up Python
        uses: actions/setup-python@v4.6.1
        with:
          python-version: "3.11.3"

      - name: Generate Project Report PDF
        run: |
          pdflatex Final-Project-Report-Team-2.tex
          pdflatex Project-Proposal-Team-2.tex

      - name: Upload Project Report PDFs
        uses: actions/upload-artifact@v2
        with:
          name: documents
          path: |
            Final-Project-Report-Team-2.pdf
            Project-Proposal-Team-2.pdf

  release:
    needs: build
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Check out main branch
        uses: actions/checkout@v3.5.3
        with:
          ref: main
          fetch-depth: '0'

      - name: Download PDF artifact
        uses: actions/download-artifact@v2.1.1
        with:
          name: documents

      - name: Get Version
        id: get_version
        run: echo "version=$(cat release.txt)" >> $GITHUB_ENV

      - name: Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: ${{ env.version }}
          files: |
            Project-Proposal-Team-2.pdf
            Final-Project-Report-Team-2.pdf
            Final-Project-Team-2.mp4
          body: |
            DELIVERABLES:
              - [Project-Proposal-Team-2.pdf](https://github.com/team2-su23-aai501/project/releases/download/${{ env.version }}/Project-Proposal-Team-2.pdf)
              - [Final-Project-Report-Team-2.pdf](https://github.com/team2-su23-aai501/project/releases/download/${{ env.version }}/Final-Project-Report-Team-2.pdf)
              - [Final-Project-Report-Team-2.mp4](https://github.com/team2-su23-aai501/project/releases/download/${{ env.version }}/Final-Project-Team-2.mp4)
          draft: false
          prerelease: true
